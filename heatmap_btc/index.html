<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BTC 3D Candlestick Chart</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { margin:0; background:#111; color:#fff; overflow:hidden; }
    #chart { width:100vw; height:100vh; }
  </style>
</head>
<body>
  <div id="chart"></div>
  <script>
    const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    let candleMatrix=Array.from({length:7},()=>Array(24).fill({open:0,close:0,high:0,low:0}));

    async function fetchInitialData(){
      const now=new Date();
      const sunMidnight=new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()-now.getUTCDay()));
      const res=await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&startTime=${sunMidnight.getTime()}`);
      const candles=await res.json();
      candles.forEach(c=>{
        const date=new Date(c[0]);
        const d=date.getUTCDay(),h=date.getUTCHours();
        candleMatrix[d][h]={open:+c[1],high:+c[2],low:+c[3],close:+c[4]};
      });
      plotChart();
    }

    function plotChart(){
      const bars={x:[],y:[],z:[],type:'bar3d',colorscale:'Jet',opacity:0.9};
      const wicks={x:[],y:[],z:[],mode:'lines',type:'scatter3d',line:{color:'#fff',width:2}};

      for(let d=0; d<7; d++){
        for(let h=0; h<24; h++){
          const c=candleMatrix[d][h];
          const body=Math.abs(c.close-c.open);
          const base=Math.min(c.open,c.close);

          bars.x.push(h);
          bars.y.push(d);
          bars.z.push(body);

          wicks.x.push(h,h,null);
          wicks.y.push(d,d,null);
          wicks.z.push(c.low,c.high,null);
        }
      }

      Plotly.newPlot('chart',[bars,wicks],{
        scene:{
          xaxis:{title:'Hour',dtick:1},
          yaxis:{title:'Day',tickvals:[0,1,2,3,4,5,6],ticktext:days,dtick:1},
          zaxis:{title:'Price Range'},
          camera:{eye:{x:1.6,y:1.6,z:0.6}}
        },
        margin:{t:40,b:10,l:10,r:10},
      });
    }

    const ws=new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@kline_1h');
    ws.onmessage=(e)=>{
      const k=JSON.parse(e.data).k,date=new Date(k.t),d=date.getUTCDay(),h=date.getUTCHours();
      candleMatrix[d][h]={open:+k.o,high:+k.h,low:+k.l,close:+k.c};
      plotChart();
    };

    fetchInitialData();
  </script>
</body>
</html>
