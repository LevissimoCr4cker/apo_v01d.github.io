<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üî• BTC Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #111; color: white; overflow-x: hidden; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background-color: rgba(0,0,0,0.5); }
    h1 { font-size: 1.5rem; margin: 0; }
    .dropdown { position: relative; display: inline-block; }
    .dropbtn { background-color: #222; color: white; padding: 0.5rem 1rem; font-size: 1rem; border: none; cursor: pointer; border-radius: 6px; }
    .dropdown-content { display: none; position: absolute; right: 0; background-color: #222; min-width: 160px; border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.3); z-index: 1; }
    .dropdown-content a { color: white; padding: 0.75rem 1rem; text-decoration: none; display: block; }
    .dropdown-content a:hover { background-color: #333; }
    .dropdown:hover .dropdown-content { display: block; }
    #graph { width: 100%; height: 75vh; }
    .info { text-align: center; background-color: #222; padding: 1rem; margin: 1rem auto; max-width: 800px; border-radius: 10px; }
    .info strong { color: #ffcc00; }
    .back { display: block; text-align: center; margin: 2rem auto; color: #999; text-decoration: none; }
    .back:hover { color: white; }
    #custom-date-form { display: none; background-color: #222; padding: 1rem; margin: 1rem auto; max-width: 800px; border-radius: 10px; text-align: center; }
    #custom-date-form input, #custom-date-form button { padding: 0.5rem; margin: 0.5rem; border-radius: 4px; border: none; }
    @media (max-width:600px){header{flex-direction:column;align-items:flex-start;} .dropbtn{width:100%;}}
  </style>
</head>
<body>
  <header>
    <h1>üî• BTC Heatmap</h1>
    <div class="dropdown">
      <button class="dropbtn">Period ‚éè</button>
      <div class="dropdown-content">
        <a href="#" onclick="loadPeriod('week')">This Week</a>
        <a href="#" onclick="loadPeriod('month')">This Month</a>
        <a href="#" onclick="loadPeriod('year')">This Year</a>
        <a href="#" onclick="showCustomForm()">Custom</a>
      </div>
    </div>
  </header>

  <div id="custom-date-form">
    <label>Start: <input type="date" id="start-date"></label>
    <label>End: <input type="date" id="end-date"></label>
    <button onclick="submitCustom()">Apply</button>
  </div>

  <div id="graph"></div>
  <a class="back" href="/index.html">‚Üê Return to Main Page</a>

  <script>
    const API = 'https://api.binance.com/api/v3/klines';
    const SYMBOL = 'BTCUSDT';
    const MS = {week:7*86400000, month:30*86400000, twoYear:2*365*86400000};

    async function getKlines(interval, start, end) {
      const url = `${API}?symbol=${SYMBOL}&interval=${interval}&startTime=${start}&endTime=${end}&limit=1000`;
      return fetch(url).then(r=>r.json());
    }

    function plotCandles3D(klines, type) {
      const x=[], y=[], z0=[], z1=[], z2=[], colors=[];
      klines.forEach(k=>{
        const [openT, o,h,l,c] = k;
        const date=new Date(openT);
        let xi, yi;
        if(type==='week'){
          yi=(date.getUTCDay()+6)%7;
          xi=date.getUTCHours();
        } else if(type==='month'){
          yi=(date.getUTCDay()+6)%7;
          xi=date.getUTCDate();
        } else {
          yi=date.getUTCDate();
          xi=date.getUTCMonth();
        }
        x.push(xi); y.push(yi);
        z0.push(parseFloat(l)); // low
        z1.push(parseFloat(o)); // open
        z2.push(parseFloat(c)); // close
        colors.push(c>o?'green':'red');
      });
      const traces=[
        // wicks
        { x:x, y:y, z:z0, mode:'lines', type:'scatter3d', line:{color:'gray',width:2} },
        { x:x, y:y, z:z2.map((_,i)=>z1[i]), mode:'lines', type:'scatter3d', line:{color:'gray',width:2} },
        // bodies
        { x:x, y:y, z:z1, mode:'markers', type:'scatter3d', marker:{symbol:'square','size':6, color:colors} }
      ];
      const layout={
        scene:{
          xaxis:{title:type==='year'?'Month':type==='month'?'Day of Month':'Hour',tickvals:type==='year'?[...Array(12).keys()]:undefined,ticktext:type==='year'?['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']:undefined},
          yaxis:{title:type==='year'?'Day of Month':type==='month'?'Day of Week':'Day of Week',tickvals:undefined,ticktext:undefined},
          zaxis:{title:'Price(USD)'}
        },paper_bgcolor:'#111',font:{color:'white'},margin:{l:0,r:0,b:0,t:0}
      };
      Plotly.newPlot('graph',traces,layout,{responsive:true});
    }

    async function loadPeriod(period, start, end) {
      document.getElementById('custom-date-form').style.display='none';
      let now=Date.now(), st, iv;
      if(period==='week'){ iv='1h'; st=now-MS.week; }
      else if(period==='month'){ iv='4h'; st=now-MS.month; }
      else if(period==='year'){ iv='1d'; st=now-365*86400000; }
      else { iv=(end-start>MS.twoYear?'1M':'1d'); st=new Date(start).getTime(); now=new Date(end).getTime(); }
      const kl=await getKlines(SYMBOL,iv,st,now);
      plotCandles3D(kl,period);
      if(period==='week') setTimeout(()=>loadPeriod('week'),60000);
    }

    function showCustomForm(){ document.getElementById('custom-date-form').style.display='block'; }
    function submitCustom(){ const s=document.getElementById('start-date').value,e=document.getElementById('end-date').value; if(s&&e) loadPeriod('custom',s,e); }

    loadPeriod('week');
  </script>
</body>
</html>
